# 温湿度数据系统重构开发文档

## 1. 背景与总体目标
- 现有系统基于 Flask + SQLite 的单体结构，难以满足企业级并发、权限与运维诉求。
- 计划引入前后端分离、企业微信认证、可靠的数据导入/分析/告警链路，并支持 PC 与移动端自适应体验。
- 本文档明确新的技术选型、目标架构、模块划分及实施路线，指导后续开发与迁移工作。

## 2. 技术选型
### 2.1 前端
- **框架**：React 18 + Vite + TypeScript
- **UI 组件**：Ant Design Pro（PC）+ Ant Design Mobile（移动适配），辅以 Tailwind CSS（可选）
- **状态管理**：Redux Toolkit / Zustand（按需求选用）
- **构建与部署**：CI 产出静态资源，托管于 Nginx / CDN；支持 PWA 提升移动体验

### 2.2 后端
- **语言/框架**：Node.js 20+、NestJS（Monorepo 结构，可使用 Nx 管理）
- **API 协议**：REST + WebSocket，预留 GraphQL 接口演进空间
- **鉴权框架**：企业微信 OAuth + JWT（Access Token + Refresh Token）
- **异步任务**：BullMQ（Redis 作为队列存储）
- **配置管理**：@nestjs/config + dotenv，多环境配置隔离
- **日志/监控**：Winston + Prometheus 指标导出；集中日志引入 Loki/ELK

### 2.3 数据与存储
- **主数据库**：MySQL 8.x（分库分表预留、InnoDB 引擎）
- **缓存**：Redis（Session、热点数据、限流计数）
- **对象存储**：MinIO / 企业级 OSS（存储原始 Excel、任务日志）
- **消息队列**：RabbitMQ（备选）或延续 BullMQ（Redis Stream）实现
- **配置/密钥**：Vault / KMS（长期方案），短期使用环境变量 + 加密 Vault 文件

### 2.4 DevOps
- **版本管理**：Git + Git Flow / Trunk-based
- **CI/CD**：GitHub Actions 或 GitLab CI；构建前端、后端镜像并推送私有仓库
- **部署**：起步使用 Docker Compose，逐步迁移至 Kubernetes（Helm Charts）
- **监控**：Prometheus + Grafana；告警统一入口接入 Ops 平台

## 3. 目标系统架构
```
┌────────────────────────┐
│      前端 Web/PWA       │ React 18 + Vite + AntD Pro
└───────────────▲────────┘
                │ HTTPS (REST/WebSocket)
┌───────────────┴────────────────────────────┐
│          API Gateway / BFF (NestJS)         │
│  - 企业微信 OAuth 鉴权                     │
│  - 用户权限 & JWT 签发                     │
│  - 请求聚合、限流、Audit 日志              │
└──────▲───────────┬───────────────▲────────┘
       │           │               │
       │           │               │
┌──────┴──────┐ ┌──┴─────────┐ ┌───┴────────┐ ┌──────────────┐
│IngestionSvc │ │AnalyticsSvc│ │AlertingSvc│ │WeCom Adapter │
│Excel解析入库│ │历史查询统计│ │阈值&消息流│ │OAuth/用户同步│
└──────▲──────┘ └────▲───────┘ └────▲──────┘ └──────▲───────┘
       │             │              │              │
       ▼             ▼              ▼              ▼
┌────────────┐ ┌────────────┐ ┌────────────┐ ┌──────────────┐
│  Redis     │ │  MySQL 8   │ │  RabbitMQ  │ │   对象存储    │
│（缓存/队列）│ │（主存储）  │ │（事件流）  │ │Excel/日志归档│
└────────────┘ └────────────┘ └────────────┘ └──────────────┘
```

## 4. 模块划分与职责
### 4.1 Gateway/BFF（apps/gateway）
- 提供统一入口，处理企业微信登录、JWT 签发与刷新
- 实现角色/权限校验、API 组合、请求限流
- 对接前端，返回领域聚合数据

### 4.2 Ingestion Service（apps/ingestion）
- 负责 Excel/CSV 文件解析 -> 标准化数据模型 -> 队列入库
- 利用 BullMQ 定义导入任务、进度跟踪、失败重试
- 支持大文件分片上传与断点续传；写入 MySQL 时采用批量 UPSERT

### 4.3 Analytics Service（apps/analytics）
- 提供历史数据查询、统计报表、导出
- 使用 TypeORM（或 Prisma）与 MySQL 交互，支持分区表与索引优化
- 暴露 WebSocket 通道实现实时刷新、长时间查询任务轮询

### 4.4 Alerting Service（apps/alerting）
- 管理阈值策略、调度规则（基于 BullMQ 定时任务或 cron service）
- 监控新入库数据，触发告警事件写入队列
- 输出渠道暂为站内通知/API；后续再扩展企业微信消息

### 4.5 WeCom Adapter（apps/wecom-adapter）
- 处理企业微信 OAuth 流程、用户信息同步
- 提供统一 SDK（shared/libs/wecom-client.ts）供其它服务调用
- 后续扩展消息推送/审批时使用

### 4.6 Shared 库
- DTO、校验器、通用异常处理、数据库实体、配置读取、日志格式化
- 提供跨服务可复用的工具集，保证编码规范一致

## 5. 数据库设计原则（MySQL）
- **库划分**：`th_system` 主库；按业务划分表（sensor_data、areas、thresholds、import_jobs、alerts 等）
- **时间序列策略**：sensor_data 采用按月/日分区表或带时间索引的表结构（InnoDB + 复合索引）
- **多租户/权限**：使用逻辑租户字段或视图控制；配合应用层 RBAC
- **数据一致性**：写操作封装事务；导入流程采用幂等键（area + timestamp）
- **归档策略**：定期将历史数据导出至归档库或对象存储，减少主库压力

## 6. 企业微信集成规划
1. **阶段一（当前范围）**：仅实现 OAuth 登录
   - 在企业微信管理后台配置重定向 URL（Gateway 服务）
   - 登录流程：二维码授权 -> 获取 code -> 后端换取用户信息 -> 建立/更新用户表 -> 颁发 JWT
   - 在前端缓存 JWT（HttpOnly Cookie/LocalStorage），统一通过网关进行鉴权
2. **阶段二（后续扩展）**：消息推送 / 审批流
   - WeCom Adapter 新增消息模板、机器人推送、审批事件处理
   - 与 Alerting Service、运维事件联动

## 7. 目录结构建议
```
TemperatureHumiditySuite/
├── docs/
│   ├── 开发文档.md (本文)
│   ├── api/
│   └── adr/
├── apps/
│   ├── gateway/
│   ├── ingestion/
│   ├── analytics/
│   ├── alerting/
│   └── wecom-adapter/
├── frontend/
│   └── web-app/
├── shared/
│   ├── libs/
│   └── config/
├── infra/
│   ├── docker/
│   ├── k8s/
│   └── terraform/ (可选)
├── scripts/
│   ├── data-migration/
│   └── maintenance/
└── tests/
    ├── integration/
    └── e2e/
```

## 8. 重构实施步骤
1. **需求复盘与详细设计（1-2 周）**
   - 与业务/安全确认流程、权限、企业微信回调参数
   - 输出 API 契约、数据库 E-R 图、消息流与时序图
2. **基础设施搭建（2 周，可并行）**
   - 部署 MySQL（主从/高可用）、Redis、消息队列、对象存储
   - 配置 CI/CD、单元测试模板、代码规范校验（ESLint、Prettier、Husky）
3. **服务开发阶段（4-6 周）**
   - P1：完成 Gateway、WeCom 登录、用户与权限基础模块
   - P2：实现 Ingestion Service（上传、解析、导入任务）、Analytics Service（基础查询）
   - P3：完善 Alerting Service、站内通知、阈值管理
4. **前端重构（与 P2/P3 并行，约 4 周）**
   - 建立 UI 组件、布局系统，适配 PC/移动；完成主要功能页面
   - 接入企业微信登录、任务进度、告警视图
5. **数据迁移与同步（2 周）**
   - 编写 SQLite -> MySQL 迁移脚本，验证数据量、索引、编码
   - 导入历史数据，确保幂等；旧系统切换只读
6. **联调、压测与灰度（2 周）**
   - 端到端流程验证：导入 -> 查询 -> 阈值告警 -> 权限
   - 压测导入峰值、查询并发，优化 SQL 与缓存策略
   - 灰度发布，收集反馈，完成正式上线
7. **运维交接与持续改进**
   - 输出运维手册、监控告警策略、应急预案
   - 建立定期回顾机制，规划消息推送等后续迭代

## 9. 数据迁移与兼容策略
- 编写迁移工具（TypeScript + node-sqlite + mysql2）读取旧 SQLite 分区数据并写入 MySQL
- 迁移流程：提取数据 -> 数据清洗/标准化 -> 批量写入 -> 校验行数/校验散列 -> 生成报告
- 迁移窗口内保持旧系统只读；新系统验证无误后切换写流量
- 提供只读 API 兼容层，确保历史查询可用

## 10. 风险与缓解
| 风险 | 描述 | 缓解策略 |
|------|------|----------|
| 数据迁移不完整 | SQLite 原始数据格式多样、存在缺失或重复 | 迁移前清洗、建立校验规则；增量迁移演练 |
| 并发冲突 | 导入与查询同时访问热点表 | 通过队列串行写入、读写分离、合理索引与缓存 |
| 企业微信配置变更 | 授权回调、IP 白名单调整导致登录失败 | 提前测试多环境配置，记录手册，设置监控 |
| 异步任务积压 | 导入峰值导致队列堆积 | 监控队列长度、动态扩容 Worker、设置失败告警 |
| 多端适配问题 | 移动端页面布局错乱 | 建立响应式设计规范，使用 Storybook/E2E 测试覆盖 |

## 11. 后续规划
- 阶段性引入消息推送、审批、流程编排
- 评估数据湖/大数据分析需求，必要时对接 ClickHouse / Data Warehouse
- 引入自动化运维（Terraform、GitOps）与安全审计（WAF、AOP 日志）
- 形成 ADR（Architecture Decision Record），记录每次关键技术决策

---
本文档将根据实施进展持续更新，请在变更后同步至仓库并通知团队成员。
