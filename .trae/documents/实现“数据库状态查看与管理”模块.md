## 需求更新
- 时间段需支持“多段非连续”的识别与展示，而非仅最小/最大时间。
- 导出/移除需能按多段时间范围与区域组合进行操作。

## 后端 API（新增/调整）
- `GET /api/analytics/area/:areaId/segments`
  - 参数：`granularity: 'record'|'day'`（默认 `day`）、`start?: number`、`end?: number`、`limit?: number`（防止过多段）、`gapToleranceMinutes?: number`（仅在 `record` 粒度下生效）。
  - 返回：`{ segments: [{ start, end, count }], segmentsCount }`
- `GET /api/analytics/areas`
  - 在每项中新增 `segmentsCount`（段数量），详细段数据通过上面的单独接口懒加载。
- `POST /api/analytics/export`
  - Body：`{ areaIds?: string[], ranges?: [{ start, end }], granularity?: 'record'|'day' }`
  - 若传 `ranges` 则按多段导出；否则按整体筛选导出。
- `DELETE /api/analytics/data`
  - Body：`{ areaIds?: string[], ranges?: [{ start, end }], granularity?: 'record'|'day', dryRun?: boolean }`
  - 返回：`{ affected, preview?: { byArea: [{ areaId, count }], byRange?: [{ start, end, count }] } }`

## 段识别算法
- `day` 粒度（推荐，性能优）：
  - 依赖 MySQL 8 窗口函数：
    - 思路：对 `DATE(timestamp)` 排序，计算 `ROW_NUMBER()`；用 `DATEDIFF(date, '1970-01-01') - ROW_NUMBER()` 作为组标识，`GROUP BY` 得到连续日期段的最小/最大值，即为一个段。
    - 结果统计 `COUNT(*)`（可用 `COUNT(DISTINCT DATE(timestamp))`）。
  - 优点：一次 SQL 即得全部连续段；可索引命中 `area_id`、`timestamp`。
- `record` 粒度（更细致，代价高）：
  - 服务器流式扫描指定区域与时间范围的记录（已按索引排序），当相邻记录时间差大于 `gapToleranceMinutes` 即断段，形成 `{start,end,count}` 列表。
  - 适合数据缺失频繁且需要精准断点时使用；支持 `limit` 限制段数量。
- 兼容性：若 MySQL < 8 无窗口函数，可退化为“distinct days + 服务器侧分段”策略。

## 数据结构与性能
- 索引：确保 `INDEX (area_id)`、`INDEX (timestamp)`，建议增加 `INDEX (area_id, timestamp)`。
- 限流与分页：`segments` 接口提供 `limit`，前端懒加载；大规模导出/删除需 `dryRun` 预估并二次确认。
- 统计缓存（可选）：对热门区域的 `day` 段结果缓存，设定 TTL，降低重复计算开销。

## 前端交互
- `DatabaseStatusPage` 区域列表中增加“段数量”列与“查看段”操作，点击后侧边抽屉展示多段时间（带记录数），支持勾选某些段用于导出/删除。
- 筛选器：区域多选、时间范围；在查看段时允许额外设置粒度与容忍间隔。
- 导出/移除：
  - 导出：将用户勾选的段与区域作为 `ranges + areaIds` 提交，返回 CSV 下载。
  - 移除：先发 `dryRun` 获取预估计数与按段预览，确认后执行删除，完成后刷新统计与段列表。

## 验证
- 构造含“断档”的测试数据（例如：2024-01 有数据、2024-02 缺失、2024-03 再有数据），验证 `day` 粒度段识别是否得到两段；`record` 粒度在设定的 `gapToleranceMinutes` 下得到更细分段。
- 验证导出文件是否仅包含选中段的数据；删除后统计与段数量同步更新。

## 增量实施
- Phase 1：后端 `day` 段识别与接口、前端段抽屉与勾选导出。
- Phase 2：`record` 粒度与 `gapToleranceMinutes` 支持、`dryRun` 预览与二次确认删除。
- Phase 3：缓存与性能优化、可视化时间轴/段条形图（可选）。