## 总体目标
- 用户管理：建立用户/角色(admin/manager/user)与RBAC框架，提前集成企业微信(WeCom)登录的QR与OAuth2两种方式与JWT签发；暂不强制启用路由守卫。
- 系统设置：新增独立表`area_defaults`，提供每个区域的温/湿上下限、持续时间、容忍时间、容错预算等默认参数的配置接口与前端页面。

## 关键确认（已纳入设计）
- 登录页同时提供QR与OAuth2两种登录入口；回调域名后续再配。
- 新建独立`area_defaults`表。
- 初次登录用户默认角色固定为`user`，后续由`admin`在用户管理页配置角色。

## 后端实现（NestJS + TypeORM + JWT）
### 模块划分
1. `AuthModule`：企业微信接入、回调处理、JWT签发与校验
2. `UsersModule`：用户实体/仓储/服务/控制器
3. `RbacModule`：角色枚举与权限映射、`@Roles()`装饰器、`RolesGuard`（暂不挂全局）
4. `SettingsModule`：`area_defaults`实体与CRUD控制器

### 配置与环境
- `.env`：`WE_COM_CORP_ID`、`WE_COM_AGENT_ID`、`WE_COM_SECRET`、`WE_COM_REDIRECT_URI`、`WE_COM_LOGIN_MODE`(可选)、`JWT_SECRET`、`JWT_EXPIRES_IN`

### 数据模型
- `users`：`id`、`username`、`wecom_user_id`、`password_hash`(可选，仅本地账号)、`role`(enum)、`status`、`created_at/updated_at`
- `area_defaults`：`id`、`area_code`(唯一/外键)、`temp_min`、`temp_max`、`humidity_min`、`humidity_max`、`temp_duration_min`、`humidity_duration_min`、`gap_tolerance_minutes`、`tolerance_normal_budget`、`updated_by`、`updated_at`
- 角色到模块权限映射`ROLE_PERMISSIONS`：
  - admin：`[import,status,analysis,settings,users]`
  - manager：`[import,status,analysis,settings]`
  - user：`[analysis]`

### 企业微信登录流程
- 登录URL生成：`GET /auth/wecom/login-url`返回两个URL：`qr_url`与`oauth_url`，包含`state`
- 回调处理：`GET /auth/wecom/callback?code=&state=`
  - 用`code`换取`userId/openId`，可选拉取`user/get`详情
  - `users`表按`wecom_user_id`查找；不存在则创建用户，`role='user'`
  - 签发JWT(payload含`sub/role/username`)，重定向前端或返回JSON
- 会话接口：`GET /auth/me`返回当前用户信息；`POST /auth/logout`可选

### 控制器接口
- `UsersController`(admin)：`GET/POST/PUT/DELETE /users`
- `SettingsController`：
  - `GET /settings/areas`（复用`area`）
  - `GET /settings/defaults?area=code`
  - `PUT /settings/defaults`（upsert）
  - `GET /settings/defaults/global`（可选）

### 守卫策略
- 提供`@Roles()`与`RolesGuard`，先不挂到全局；后续对具体控制器启用。

## 前端实现（React + AntD + Axios）
### 路由与页面
- `/login`：显示QR登录与OAuth2按钮；请求`/auth/wecom/login-url`后跳转相应URL；回调后存储JWT并`GET /auth/me`校验
- `/users`：用户列表与编辑（角色、状态、重置密码）
- `/settings`：区域默认参数表单（选择区域→读取→编辑→保存）

### 前端服务
- Axios拦截器在登录后注入`Authorization: Bearer <JWT>`；401时清理并跳转登录
- 统一定义`ROLE_PERMISSIONS`与`ModuleKey`，准备路由守卫工具（默认不启用）

## 渐进接入计划
- Phase A：后端模块与接口完成；前端登录与两页面骨架完成；不影响现有业务访问
- Phase B：启用前端菜单可见性控制与后端按模块启用`RolesGuard`
- Phase C：智能分析页读取`area_defaults`作为初始值/兜底（可开关）

## 测试计划
- 后端：Mock企业微信响应的回调流程、JWT签发与验证、用户创建/绑定、`area_defaults`CRUD
- 前端：登录流程、令牌持久化、列表与表单交互、401处理

## 风险与依赖
- 需确认企业微信应用类型与对应API；回调域名需要在企业微信后台白名单配置
- 严禁明文密码与日志泄露；默认仅使用企业微信身份

## 交付物
- 后端模块与接口的代码框架、实体与迁移
- 前端登录页、用户管理页、系统设置页骨架与调用服务
- 文档：环境变量说明与接入步骤（含企业微信后台配置项）

## 待确认/补充
- 是否需要用户状态`disabled`的软删除模式
- 是否需要导入/导出配置的备份功能（JSON）
- 前端菜单入口是否立刻可见，还是暂时隐藏，仅通过路径访问