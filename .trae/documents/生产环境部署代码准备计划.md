## 范围与目标
- 目标：基于当前开发库结构，整理并输出可用于生产初始化/迁移的 SQL 脚本计划，保证幂等、可回滚、字段/索引一致、字符集统一。
- 数据库：MySQL（InnoDB、utf8mb4_unicode_ci）。

## 现有表与结构摘要
- areas（来源：entities/area.entity.ts）
  - 字段：id PK unsigned、code(varchar64 unique)、name(varchar128)、location(varchar255 null)、created_at/updated_at
- sensor_data（来源：entities/sensor-data.entity.ts）
  - 字段：id PK、area_id BIGINT unsigned FK→areas.id、timestamp(datetime)、temperature decimal(5,2) null、humidity decimal(5,2) null、file_source varchar(255) null、created_at/updated_at
  - 索引：idx_sensor_data_timestamp(timestamp)、uk_sensor_data_area_timestamp(area_id,timestamp) 唯一
- users（来源：users/schema-init.service.ts + entities/user.entity.ts）
  - 字段：id PK、username(varchar100 unique)、wecom_user_id(varchar100 unique null)、password_hash(varchar255 null)、role(varchar20 default 'user')、status INT default 1、created_at/updated_at
  - 清理：删除旧列 user_id/name；确保 PRIMARY KEY(id) 与唯一索引 uniq_username/uniq_wecom
- area_defaults（来源：settings/schema-init.service.ts + entities/area-defaults.entity.ts）
  - 字段：id PK、area_code(varchar100 unique)、temp_min/max(float)、humidity_min/max(float)、temp_duration_min(int)、humidity_duration_min(int)、gap_tolerance_minutes(int default 30)、tolerance_normal_budget(int default 0)、updated_by(varchar100 null)、created_at/updated_at
  - 同步：从 areas 插入缺失行；可选创建触发器（受 binlog 权限限制）
- 清理：删除遗留 thresholds、import_anomalies。

## 迁移策略
- 基线迁移（V1）：创建核心表（areas、sensor_data、users、area_defaults），统一字符集/排序规则，建立主键/唯一键/索引。
- 数据迁移（V2）：同步 area_defaults 缺失行（INSERT IGNORE FROM areas）。
- 兼容迁移（V3）：users 清理旧列与主键重设、补充唯一索引；删除遗留表。
- 触发器可选迁移（V4）：在权限允许时创建 `areas_defaults_sync` 触发器；否则跳过并由应用层负责同步。
- 幂等：通过 INFORMATION_SCHEMA 检查列/索引/触发器是否存在再执行；`CREATE TABLE IF NOT EXISTS`；`INSERT IGNORE`。

## 迁移脚本结构（示例片段）
- V1__baseline.sql：
  - 创建 areas：
    ```sql
    CREATE TABLE IF NOT EXISTS areas (
      id INT UNSIGNED NOT NULL AUTO_INCREMENT,
      code VARCHAR(64) NOT NULL UNIQUE,
      name VARCHAR(128) NOT NULL,
      location VARCHAR(255) NULL,
      created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
      updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
      PRIMARY KEY (id)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
    ```
  - 创建 sensor_data：
    ```sql
    CREATE TABLE IF NOT EXISTS sensor_data (
      id INT UNSIGNED NOT NULL AUTO_INCREMENT,
      area_id BIGINT UNSIGNED NOT NULL,
      timestamp DATETIME NOT NULL,
      temperature DECIMAL(5,2) NULL,
      humidity DECIMAL(5,2) NULL,
      file_source VARCHAR(255) NULL,
      created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
      updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
      PRIMARY KEY (id),
      UNIQUE KEY uk_sensor_data_area_timestamp (area_id, timestamp),
      KEY idx_sensor_data_timestamp (timestamp),
      CONSTRAINT fk_sensor_area FOREIGN KEY (area_id) REFERENCES areas(id) ON UPDATE CASCADE ON DELETE RESTRICT
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
    ```
  - 创建 users：
    ```sql
    CREATE TABLE IF NOT EXISTS users (
      id INT UNSIGNED NOT NULL AUTO_INCREMENT,
      username VARCHAR(100) COLLATE utf8mb4_unicode_ci NOT NULL,
      wecom_user_id VARCHAR(100) COLLATE utf8mb4_unicode_ci NULL,
      password_hash VARCHAR(255) COLLATE utf8mb4_unicode_ci NULL,
      role VARCHAR(20) COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT 'user',
      status INT NOT NULL DEFAULT 1,
      created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
      updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
      PRIMARY KEY (id),
      UNIQUE KEY uniq_username (username),
      UNIQUE KEY uniq_wecom (wecom_user_id)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
    ```
  - 创建 area_defaults：
    ```sql
    CREATE TABLE IF NOT EXISTS area_defaults (
      id INT UNSIGNED NOT NULL AUTO_INCREMENT,
      area_code VARCHAR(100) COLLATE utf8mb4_unicode_ci NOT NULL,
      temp_min FLOAT NOT NULL,
      temp_max FLOAT NOT NULL,
      humidity_min FLOAT NOT NULL,
      humidity_max FLOAT NOT NULL,
      temp_duration_min INT NOT NULL,
      humidity_duration_min INT NOT NULL,
      gap_tolerance_minutes INT NOT NULL DEFAULT 30,
      tolerance_normal_budget INT NOT NULL DEFAULT 0,
      updated_by VARCHAR(100) COLLATE utf8mb4_unicode_ci NULL,
      created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
      updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
      PRIMARY KEY (id),
      UNIQUE KEY uniq_area_code (area_code)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
    ```
- V2__sync_area_defaults.sql：
  ```sql
  INSERT IGNORE INTO area_defaults (
    area_code, temp_min, temp_max, humidity_min, humidity_max,
    temp_duration_min, humidity_duration_min, gap_tolerance_minutes, tolerance_normal_budget, updated_by
  )
  SELECT a.code, 20, 26, 40, 70, 30, 30, 30, 0, NULL
  FROM areas a
  WHERE NOT EXISTS (
    SELECT 1 FROM area_defaults d WHERE d.area_code COLLATE utf8mb4_unicode_ci = a.code COLLATE utf8mb4_unicode_ci
  );
  ```
- V3__users_cleanup.sql：
  ```sql
  -- 删除旧列 name/user_id（存在才删除）
  SET @has_name := (SELECT COUNT(*) FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_SCHEMA = DATABASE() AND TABLE_NAME = 'users' AND COLUMN_NAME = 'name');
  SET @has_user_id := (SELECT COUNT(*) FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_SCHEMA = DATABASE() AND TABLE_NAME = 'users' AND COLUMN_NAME = 'user_id');
  SET @has_pk_id := (SELECT COUNT(*) FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE WHERE TABLE_SCHEMA = DATABASE() AND TABLE_NAME = 'users' AND CONSTRAINT_NAME = 'PRIMARY' AND COLUMN_NAME = 'id');
  DO CASE WHEN @has_user_id > 0 THEN (SELECT 1) ELSE (SELECT 0) END; -- 伪代码：实际按工具拆分
  -- 建议用迁移工具或脚本按条件执行：
  -- ALTER TABLE users DROP PRIMARY KEY; ALTER TABLE users DROP COLUMN user_id; ALTER TABLE users ADD PRIMARY KEY(id);
  -- IF @has_name > 0 THEN ALTER TABLE users DROP COLUMN name;
  -- 索引幂等：检查 INFORMATION_SCHEMA.STATISTICS 后再 ADD UNIQUE KEY uniq_username (username)、uniq_wecom (wecom_user_id)
  ```
- V4__areas_defaults_trigger.sql（可选）：
  ```sql
  -- 需 SUPER 权限或 log_bin_trust_function_creators = 1；否则跳过
  DROP TRIGGER IF EXISTS areas_defaults_sync;
  CREATE TRIGGER areas_defaults_sync AFTER INSERT ON areas
  FOR EACH ROW INSERT IGNORE INTO area_defaults (
    area_code, temp_min, temp_max, humidity_min, humidity_max,
    temp_duration_min, humidity_duration_min, gap_tolerance_minutes, tolerance_normal_budget, updated_by
  ) VALUES (NEW.code, 20, 26, 40, 70, 30, 30, 30, 0, NULL);
  ```
- V5__cleanup_legacy.sql：
  ```sql
  DROP TABLE IF EXISTS thresholds;
  DROP TABLE IF EXISTS import_anomalies;
  ```

## 执行与工具选择
- 推荐工具：
  - TypeORM Migration（与 NestJS 一致）：生成 SQL/TS 迁移并在启动前执行
  - 或外部工具：Flyway/Liquibase（更适合多环境管控与幂等检查）
- 执行顺序：V1 → V2 → V3 →（可选 V4）→ V5。
- 回滚策略：基线迁移不建议自动回滚；数据迁移需在执行前快照关键表（areas/area_defaults/users）。

## 校验与对账
- 迁移前：信息架构校验（列/索引/触发器/字符集）与数据行数基线统计。
- 迁移后：
  - 表存在且列/索引匹配
  - `area_defaults` 与 `areas` 对应关系完整（每个 areas.code 均有一条 defaults）
  - 触发器存在（如启用）且 INSERT 新区域能同步默认值
  - 用户唯一索引正常生效

## 权限与注意事项
- 触发器创建受 `@@log_bin` 与 `@@log_bin_trust_function_creators` 影响；无权限则跳过并记录。
- 全局字符集/排序规则统一 `utf8mb4_unicode_ci`，避免 `Illegal mix of collations`。
- 外键：`sensor_data.area_id` → `areas.id` 采用 `CASCADE UPDATE` 与 `RESTRICT DELETE`，生产需确认删除策略。

## 下一步
- 我方按上述结构生成对应迁移文件骨架（SQL/TypeORM/Flyway任选），并在测试库跑通完整流程；随后提交迁移文件供生产执行。