## 旧代码研读与问题点
- 查询与时间段拼接
  - 时间范围修正与查询：`旧代码库/Temperature-and-Humidity-Data-Query-System/smart_query_new.py:87-181`
  - 跨分区查询及“全局时间线”排序：`smart_query_new.py:183-285`
  - 可用时间段识别与 30 分钟容忍拼接：`smart_query_new.py:287-346、324-342`
  - 缺失时间段识别：`smart_query_new.py:348-401`
- 异常分析
  - 温度/湿度异常点与连续段：`旧代码库/.../data_analyzer.py:110-175、176-283、285-340、361-468`
- 潜在问题
  - 分段拼接在“采样不均匀/时钟漂移/乱序写入”情况下可能产生误拼或漏拼
  - 连续异常段的判断严格依赖逐点布尔，未考虑“容错预算”（允许少量正常点）
  - 旧版以 SQLite 分区为基础，迁移至 MySQL 8 后可利用窗口函数提升性能与准确性

## 目标与边界
- 独立模块：温湿度“智能查询与分析”（前后端独立、与导入/数据库状态并列）
- 不落库策略：用户在查询时传入的阈值与持续时长仅用于该次分析，不写入数据库；默认阈值仍由 `thresholds` 表提供
- 输出能力
  - 智能查询：`data[]、adjustedRange、availableRanges（30min 容忍）、missingRanges`
  - 智能分析：温/湿异常点与连续异常区间（含容错预算）、阈值来源说明

## 算法优化方案
- 段拼接（时间段）
  - 统一时间排序与去重：对返回集按 `timestamp` 全局排序并去重，防止乱序/重复影响段界定
  - 自适应采样容忍：基于相邻点时间差的分位数估计采样周期 `Δt`，段合并条件由固定 30min → `k×Δt`（默认 `k=6`，约等于 30min 在 5min 采样时的容忍度）
  - SQL 端预分段（MySQL 8）：利用 `LAG(timestamp)` 与 `SUM(gap>threshold) OVER (ORDER BY timestamp)` 给片段分组，减少应用层计算压力
- 连续异常段
  - 容错预算：允许区间内最多 `n` 个正常点（默认 10% 或固定数量），防止单点“回归”打断长段
  - 基于时间而非点数的持续时长计算，支持不均匀采样
  - 类型合并策略：低/高同类异常相邻且间隙在容忍内时合段；不同类型不合并
- 缺失区间识别
  - 基于合并后的可用段与请求范围做差，间隙大于容忍视为缺失
  - 输出缺失原因分类：无早期数据、采集断流、无后期数据

## 后端实现（NestJS + MySQL 8）
- 模块：`SmartAnalyticsModule`（`backend/src/smart-analytics/`）
  - `smart-analytics.controller.ts`（`@Controller('api/smart')`）
  - `smart-analytics.service.ts`（查询、段合并、异常分析）
  - `dto/QueryDto、AnalyzeDto、SegmentsDto`（仅校验，不持久化用户参数）
  - 复用实体：`SensorData、Area、Threshold`
- 接口设计
  - `GET /api/smart/areas`：区域列表
  - `GET /api/smart/query?area&start&end&limit?`
    - 返回：`data[]、adjustedRange、availableRanges[]、missingRanges[]`
  - `GET /api/smart/segments?area&start&end&granularity=record|day&gapToleranceMinutes?`
    - 返回：按容忍度合并的片段
  - `POST /api/smart/analyze`
    - 入参：`{ area, start, end, tempMin?, tempMax?, humidityMin?, humidityMax?, tempDurationMin?, humidityDurationMin?, toleranceNormalBudget? }`
    - 行为：若提供阈值/持续时长则仅本次使用；不写阈值表
    - 返回：`stats、thresholdUsed、temperatureAnomalies、temperatureContinuous、humidityAnomalies、humidityContinuous、adjustedRange?、missingRanges?`
- 实现要点
  - 查询层：`WHERE area=? AND timestamp BETWEEN ? AND ? ORDER BY timestamp`；索引 `(area, timestamp)`
  - 段合并：应用层合并为主，可选启用 SQL 预分段（配置开关）
  - 阈值获取：默认从 `thresholds`；用户入参覆盖仅在本请求作用域；日志记录来源但不落库

## 前端实现（React + AntD）
- 页面：`SmartAnalysisPage`（与导入/数据库状态并列导航）
  - 功能：区域选择、时间范围、可选阈值/持续时长（明确“仅本次生效”文案）、查询与分析结果展示
- 服务与类型
  - `smartAnalysisService.ts`：封装 `areas/query/segments/analyze`
  - `types/smart-analysis.ts`：类型模型
- 组件
  - `SmartQueryPanel`：表单（含“仅本次生效”提示）
  - `ResultTimeline`：时间段视图（复用 ECharts 组件）、标注缺失区间
  - `AnomaliesTable`：异常点与连续异常段
  - `StatsSummary`：统计概览

## 不落库与临时数据策略
- 后端：不写入阈值表；将用户提交参数仅在该次请求上下文中使用
- 前端：在页面状态中保留用户输入；支持一键“恢复默认阈值”
- 如需跨请求暂存（可选）：使用 Redis `SETEX` 保存最近一次参数（TTL），用于用户体验但非持久规则

## 验证与测试
- 单元：时间段合并（固定/自适应容忍）、连续异常段（容错预算）、缺失识别
- 集成：三接口端到端，含大范围数据与乱序/缺失模拟
- 前端：联调与可视化验证（`adjustedRange/missingRanges`）

## 里程碑
1. 服务层算法优化与 DTO
2. 控制器与接口返回对齐
3. 前端页面/组件（最小可用）
4. 联调与性能/边界测试
5. 补充文案与用户指导（仅本次生效）

说明：已按照“研究但不照搬”的要求升级算法，并明确阈值/持续时间参数仅作临时使用、不写库。请确认后开始实现。